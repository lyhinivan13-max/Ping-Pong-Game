<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Пинг-Понг</title>
  <style>
    :root {
      --bg: #f0f0f0;
      --fg: #333333;
      --accent: #2196F3;
      --paddle: #4CAF50;
      --ball: #FFC107;
      --canvas-bg: #424242;
    }
    body.dark {
      --bg: #1e1e1e;
      --fg: #e0e0e0;
      --accent: #FF9800;
      --paddle: #f44336;
      --ball: #8BC34A;
      --canvas-bg: #212121;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: 'Segoe UI', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 10px;
      box-sizing: border-box;
      transition: background 0.3s ease, color 0.3s ease;
    }
    header {
      padding: 10px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    select, button {
      padding: 8px 15px;
      border-radius: 20px;
      border: 1px solid var(--accent);
      background: var(--bg);
      color: var(--fg);
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    select:hover, button:hover {
      background: var(--accent);
      color: var(--bg);
    }
    canvas {
      background: var(--canvas-bg);
      border: 5px solid var(--accent);
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      max-width: 95%;
      touch-action: none;
    }
    #scoreboard {
      margin-top: 20px;
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid var(--accent);
      padding: 10px;
      border-radius: 10px;
      width: 280px;
      background: var(--bg);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #scoresList {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #scoresList li {
      padding: 5px 0;
      border-bottom: 1px dashed #ccc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #scoresList li:last-child {
      border-bottom: none;
    }
    #game-controls {
        text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <label>Сложность:
      <select id="difficulty">
        <option value="easy">Легко</option>
        <option value="medium" selected>Средне</option>
        <option value="hard">Сложно</option>
      </select>
    </label>
    <label>Игрок 2:
      <select id="player2Type">
        <option value="ai" selected>Бот</option>
        <option value="human">Человек</option>
      </select>
    </label>
    <button id="themeBtn">Тема: Светлая</button>
    <button id="resetScores">Сбросить рекорды</button>
  </header>
  <canvas id="gameCanvas" width="300" height="400"></canvas>
  <div id="game-controls">
    <button id="startBtn">Начать игру</button>
    <button id="pauseBtn" style="display:none;">Пауза</button>
    <button id="restartBtn" style="display:none;">Начать заново</button>
  </div>
  <div id="scoreboard">
    <strong>Таблица рекордов</strong>
    <ul id="scoresList"></ul>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    let paddleHeight = 80, paddleWidth = 12;
    let leftPaddleY = canvas.height / 2 - paddleHeight / 2;
    let rightPaddleY = canvas.height / 2 - paddleHeight / 2;
    let ballX = canvas.width / 2, ballY = canvas.height / 2;
    let ballSpeedX = 0, ballSpeedY = 0; 
    let player1Score = 0;
    let player2Score = 0;
    let aiSpeed = 3.5;
    let player2IsHuman = false;
    let isGameOver = false;
    let gameIsStarted = false;
    let isPaused = false;
    
    let touchStartClientY = null;
    
    let aiUpdateDelay = 5;
    let aiUpdateCounter = 0;
    let ballIsFrozen = false; 
    let ballRadius = 8;
    let animationFrameId;

    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const restartBtn = document.getElementById('restartBtn');

    function drawPaddle(x, y, color) {
      ctx.fillStyle = color || getComputedStyle(document.documentElement).getPropertyValue('--paddle');
      ctx.beginPath();
      ctx.roundRect(x, y, paddleWidth, paddleHeight, 5);
      ctx.fill();
    }
    function drawBall(color) {
      ctx.fillStyle = color || getComputedStyle(document.documentElement).getPropertyValue('--ball');
      ctx.beginPath();
      ctx.arc(ballX, ballY, ballRadius, 0, Math.PI * 2);
      ctx.fill();
      ctx.closePath();
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--fg');
      ctx.setLineDash([5, 5]);
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.stroke();
      ctx.setLineDash([]);

      drawPaddle(10, leftPaddleY);
      drawPaddle(canvas.width - paddleWidth - 10, rightPaddleY);
      drawBall();

      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--fg');
      ctx.font = '24px "Segoe UI"';
      ctx.fillText(player1Score, canvas.width / 4, 30);
      ctx.fillText(player2Score, canvas.width * 3 / 4 - 15, 30);

      if (isGameOver) {
          drawGameOverScreen();
          return;
      }
      
      if (!gameIsStarted || ballIsFrozen) {
          return;
      }

      ballX += ballSpeedX;
      ballY += ballSpeedY;

      if (ballY + ballRadius > canvas.height || ballY - ballRadius < 0) {
        ballSpeedY = -ballSpeedY;
      }

      if (ballX - ballRadius < 10 + paddleWidth && ballY > leftPaddleY && ballY < leftPaddleY + paddleHeight) {
        ballSpeedX = -ballSpeedX;
        ballX = 10 + paddleWidth + ballRadius;
      }
      if (ballX + ballRadius > canvas.width - 10 - paddleWidth && ballY > rightPaddleY && ballY < rightPaddleY + paddleHeight) {
        ballSpeedX = -ballSpeedX;
        ballX = canvas.width - 10 - paddleWidth - ballRadius;
      }

      if (ballX < 0) {
        player2Score++;
        freezeAndResetBall('left');
      } else if (ballX > canvas.width) {
        player1Score++;
        freezeAndResetBall('right');
      }

      if (player1Score >= 25) {
          isGameOver = true;
          saveScore(player1Score, player2Score);
      } else if (player2Score >= 25) {
          isGameOver = true;
          saveScore(player1Score, player2Score);
      }

      if (!player2IsHuman) {
        let aiTargetY;
        if (document.getElementById('difficulty').value === 'easy') {
          aiUpdateCounter++;
          if (aiUpdateCounter >= aiUpdateDelay) {
            aiTargetY = ballY - paddleHeight / 2;
            aiUpdateCounter = 0;
          } else {
            aiTargetY = rightPaddleY + (ballY - (rightPaddleY + paddleHeight / 2)) * 0.1;
          }
        } else {
          aiTargetY = ballY - paddleHeight / 2;
        }

        const dy = aiTargetY - rightPaddleY;
        const speed = Math.abs(dy) > aiSpeed ? aiSpeed : Math.abs(dy);
        
        if (dy > 0) {
          rightPaddleY += speed;
        } else if (dy < 0) {
          rightPaddleY -= speed;
        }
        
        if (rightPaddleY < 0) rightPaddleY = 0;
        if (rightPaddleY > canvas.height - paddleHeight) rightPaddleY = canvas.height - paddleHeight;
      }
    }

    function drawGameOverScreen() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--fg');
      ctx.font = '36px "Segoe UI"';
      ctx.textAlign = 'center';
      
      let winningPlayer = player1Score >= 25 ? "Игрок 1" : "Бот";
      if (player2IsHuman && player2Score >= 25) {
          winningPlayer = "Игрок 2";
      }

      ctx.fillText(`${winningPlayer} победил!`, canvas.width / 2, canvas.height / 2);
      ctx.textAlign = 'start';
      restartBtn.style.display = 'block';
      startBtn.style.display = 'none';
      pauseBtn.style.display = 'none';
    }

    function startGame() {
        startBtn.style.display = 'none';
        restartBtn.style.display = 'none';
        pauseBtn.style.display = 'block';
        gameIsStarted = true;
        isPaused = false;
        resetBall();
        gameLoop();
    }
    
    function resetGame() {
        player1Score = 0;
        player2Score = 0;
        isGameOver = false;
        gameIsStarted = false;
        isPaused = false;
        pauseBtn.style.display = 'none';
        restartBtn.style.display = 'none';
        startBtn.style.display = 'block';
        resetBall();
        draw(); 
    }
    
    function pauseGame() {
        isPaused = !isPaused;
        pauseBtn.textContent = isPaused ? "Продолжить" : "Пауза";
        
        if (isPaused) {
            cancelAnimationFrame(animationFrameId);
        } else {
            gameLoop();
        }
    }
    
    function freezeAndResetBall(lastScorer = 'none') {
        ballIsFrozen = true;
        setTimeout(() => {
            resetBall(lastScorer);
            ballIsFrozen = false;
        }, 1000); 
    }

    function resetBall(lastScorer = 'none') {
      ballX = canvas.width / 2;
      ballY = canvas.height / 2;
      
      let speedMultiplier;
      const difficulty = document.getElementById('difficulty').value;
      if (difficulty === 'easy') {
          speedMultiplier = 0.8;
      } else if (difficulty === 'hard') {
          speedMultiplier = 1.5;
      } else { // medium
          speedMultiplier = 1;
      }
      
      let newBallSpeedX = 3 * speedMultiplier;
      let newBallSpeedY = 2 * speedMultiplier;
      
      if (lastScorer === 'left') {
        ballSpeedX = Math.abs(newBallSpeedX);
      } else if (lastScorer === 'right') {
        ballSpeedX = -Math.abs(newBallSpeedX);
      } else {
        ballSpeedX = (Math.random() > 0.5 ? 1 : -1) * newBallSpeedX;
      }
      
      ballSpeedY = (Math.random() > 0.5 ? 1 : -1) * newBallSpeedY;
    }

    document.addEventListener('keydown', e => {
      if (isGameOver || isPaused) return;
      if (e.key === 'ArrowUp' && leftPaddleY > 0) leftPaddleY -= 15;
      if (e.key === 'ArrowDown' && leftPaddleY < canvas.height - paddleHeight) leftPaddleY += 15;

      if (player2IsHuman) {
        if (e.key === 'w' && rightPaddleY > 0) rightPaddleY -= 15;
        if (e.key === 's' && rightPaddleY < canvas.height - paddleHeight) rightPaddleY += 15;
      }
    });

    canvas.addEventListener('touchstart', e => {
      e.preventDefault();
      if (isGameOver || isPaused) return;
      const touch = e.touches[0];
      if (touch.clientX < canvas.width / 2 + canvas.offsetLeft) {
        touchStartClientY = touch.clientY;
      }
    });

    canvas.addEventListener('touchmove', e => {
      e.preventDefault();
      if (isGameOver || isPaused) return;
      const touch = e.touches[0];
      if (touchStartClientY !== null && touch.clientX < canvas.width / 2 + canvas.offsetLeft) {
        const deltaY = touch.clientY - touchStartClientY;
        const newPaddleY = leftPaddleY + deltaY;
        
        if (newPaddleY >= 0 && newPaddleY <= canvas.height - paddleHeight) {
          leftPaddleY = newPaddleY;
        } else if (newPaddleY < 0) {
          leftPaddleY = 0;
        } else if (newPaddleY > canvas.height - paddleHeight) {
          leftPaddleY = canvas.height - paddleHeight;
        }
        touchStartClientY = touch.clientY;
      }
    });

    canvas.addEventListener('touchend', e => {
      e.preventDefault();
      touchStartClientY = null;
    });

    document.getElementById('difficulty').addEventListener('change', e => {
      if (e.target.value === 'easy') aiSpeed = 1.5;
      if (e.target.value === 'medium') aiSpeed = 3.5;
      if (e.target.value === 'hard') aiSpeed = 6;
      resetBall();
    });

    document.getElementById('player2Type').addEventListener('change', e => {
      player2IsHuman = (e.target.value === 'human');
    });

    const themeBtn = document.getElementById('themeBtn');
    themeBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      themeBtn.textContent = document.body.classList.contains('dark') ? 'Тема: Тёмная' : 'Тема: Светлая';
    });
    
    function saveScore(player1Score, player2Score) {
      try {
        let scores = JSON.parse(localStorage.getItem('pongScores')) || [];
        scores.push({ player1: player1Score, player2: player2Score, date: new Date().toLocaleString() });
        scores.sort((a,b) => (b.player1 + b.player2) - (a.player1 + a.player2));
        if (scores.length > 5) scores = scores.slice(0,5);
        localStorage.setItem('pongScores', JSON.stringify(scores));
      } catch (e) {
        console.error("Не удалось сохранить рекорды:", e);
      }
      renderScores();
    }

    function renderScores() {
      const list = document.getElementById('scoresList');
      list.innerHTML = '';
      try {
        const scores = JSON.parse(localStorage.getItem('pongScores')) || [];
        list.innerHTML = scores.map(s => `<li>Игрок 1: ${s.player1} - Игрок 2: ${s.player2} (${s.date})</li>`).join('');
      } catch (e) {
        console.error("Не удалось загрузить рекорды:", e);
      }
    }
    renderScores();

    document.getElementById('resetScores').addEventListener('click', () => {
      localStorage.removeItem('pongScores');
      renderScores();
    });

    startBtn.addEventListener('click', startGame);
    pauseBtn.addEventListener('click', pauseGame);
    restartBtn.addEventListener('click', resetGame);

    draw();

    function gameLoop() {
      if (isPaused || isGameOver) {
          return;
      }
      draw();
      animationFrameId = requestAnimationFrame(gameLoop);
    }
  </script>
</body>
</html>
